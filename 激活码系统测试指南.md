# 激活码系统测试指南

## 测试前准备

### 1. 启动服务

```bash
# 启动后端
cd admin-platform/server
npm run dev

# 启动前端
cd admin-platform/web
npm run dev
```

### 2. 登录超管账号

- 用户名：13800000000
- 密码：admin123

---

## 后端API测试

### 1. 生成激活码测试

**接口**: `POST /api/activation-codes`

**测试步骤**:
1. 使用Postman或curl，携带超管Token
2. 发送请求体：
```json
{
  "courseId": "已存在的课程ID",
  "count": 5,
  "maxUses": 30,
  "validFrom": "2024-01-01T00:00:00Z",
  "validUntil": "2025-12-31T23:59:59Z",
  "description": "测试激活码"
}
```

**预期结果**:
- ✅ 返回201状态码
- ✅ 返回5个激活码
- ✅ 激活码格式为 XXXX-XXXX-XXXX
- ✅ 不含易混淆字符（0O1Il）

**错误场景测试**:
- ❌ count < 1 或 > 100 → 400错误
- ❌ 无效的courseId → 400错误
- ❌ 缺少必需参数 → 400错误
- ❌ 非超管用户 → 403错误

---

### 2. 激活码列表测试

**接口**: `GET /api/activation-codes`

**测试步骤**:
1. 不带参数获取全部
2. 带courseId参数筛选
3. 带status参数筛选
4. 测试分页参数

**预期结果**:
- ✅ 返回items数组
- ✅ 包含pagination对象
- ✅ courseId字段已populate
- ✅ 正确显示使用情况（usedCount/maxUses）

---

### 3. 激活码详情测试

**接口**: `GET /api/activation-codes/:code`

**测试步骤**:
1. 使用有效激活码查询
2. 使用无效激活码查询
3. 使用已被使用的激活码查询

**预期结果**:
- ✅ 返回完整激活码信息
- ✅ 包含activations数组（使用该码的用户）
- ✅ 用户信息已populate
- ❌ 无效激活码返回404

---

### 4. 用户激活课程测试

**接口**: `POST /api/activation/activate`

**测试步骤**:
1. 学生账号登录
2. 使用有效激活码激活课程
```json
{
  "code": "ABCD-EFGH-IJKL",
  "courseId": "课程ID"
}
```

**预期结果**:
- ✅ 首次激活成功，返回201
- ✅ 激活码usedCount增加1
- ❌ 重复激活返回400
- ❌ 过期激活码返回400
- ❌ 用尽的激活码返回400
- ❌ 禁用的激活码返回400
- ❌ 课程ID不匹配返回400

---

### 5. 我的激活列表测试

**接口**: `GET /api/activation/my-activations`

**测试步骤**:
1. 激活几个课程后查询
2. 切换不同用户查询

**预期结果**:
- ✅ 返回当前用户所有激活记录
- ✅ 课程信息已populate
- ✅ 自动更新过期状态

---

### 6. 验证课程访问权限测试

**接口**: `GET /api/activation/verify?courseId=xxx`

**测试场景**:
1. 已激活且未过期 → `allowed: true`
2. 未激活 → `allowed: false, reason: not_activated`
3. 已过期 → `allowed: false, reason: expired`
4. 已撤销 → `allowed: false, reason: revoked`
5. 网络错误 → `allowed: false, reason: error`

**预期结果**:
- ✅ 验证成功更新lastVerifiedAt
- ✅ 过期自动更新status
- ✅ 即使验证失败也返回200（容错处理）

---

### 7. 撤销激活测试（超管）

**接口**: `DELETE /api/activation/revoke/:userId/:courseId`

**测试步骤**:
1. 超管撤销某用户的课程激活
2. 被撤销用户再次验证权限

**预期结果**:
- ✅ 撤销成功，status变为revoked
- ✅ 用户验证时返回allowed: false
- ❌ 非超管操作返回403

---

### 8. 激活记录列表测试

**接口**: `GET /api/activation/list`

**测试步骤**:
1. 超管查看全部记录
2. 按courseId筛选
3. 按status筛选
4. 搜索用户名/学号

**预期结果**:
- ✅ 返回符合条件的激活记录
- ✅ 支持分页
- ✅ 支持搜索

---

## 前端功能测试

### 1. 激活码管理页面测试

**路径**: `/admin/activation-codes`

**测试功能**:
1. **激活码列表**
   - ✅ 显示所有激活码
   - ✅ 显示使用情况（X/Y）
   - ✅ 显示有效期
   - ✅ 显示状态标签（启用/禁用）
   - ✅ 支持复制激活码

2. **生成激活码对话框**
   - ✅ 选择课程（下拉框）
   - ✅ 设置生成数量（1-100）
   - ✅ 设置每码可激活人数
   - ✅ 设置生效/过期时间
   - ✅ 生成成功后显示激活码列表
   - ✅ 每个激活码可复制

3. **激活码详情抽屉**
   - ✅ 显示完整信息
   - ✅ 显示使用该码的用户列表
   - ✅ 用户列表包含姓名、学号、激活时间、状态

4. **操作功能**
   - ✅ 启用/禁用激活码
   - ✅ 删除未使用的激活码
   - ❌ 已使用的激活码禁止删除

**错误处理**:
- ✅ 表单验证错误提示
- ✅ 网络错误提示
- ✅ 操作成功提示

---

### 2. 激活记录页面测试

**路径**: `/admin/activations`

**测试功能**:
1. **激活记录列表**
   - ✅ 显示用户信息（姓名、学号、手机）
   - ✅ 显示学校/班级
   - ✅ 显示课程信息
   - ✅ 显示激活码
   - ✅ 显示激活时间
   - ✅ 显示最后验证时间
   - ✅ 显示状态（激活/过期/已撤销）

2. **筛选功能**
   - ✅ 按课程筛选
   - ✅ 按状态筛选
   - ✅ 搜索用户名/学号/手机号/激活码

3. **撤销功能**
   - ✅ 撤销确认对话框
   - ✅ 撤销成功后刷新列表
   - ✅ 只有激活状态可撤销

**权限测试**:
- ✅ 超管可查看所有记录
- ✅ 学生只能看自己的记录

---

## 集成测试场景

### 场景1：完整激活流程

1. 超管生成激活码
2. 将激活码发给学生
3. 学生登录系统
4. 学生输入激活码激活课程
5. 学生查看"我的激活"列表
6. 启动器验证权限通过
7. 课程应用正常启动

**验证点**:
- ✅ 激活码usedCount正确增加
- ✅ 用户激活记录正确创建
- ✅ 权限验证返回allowed: true
- ✅ lastVerifiedAt正确更新

---

### 场景2：激活码到期处理

1. 生成即将过期的激活码
2. 用户激活课程
3. 等待激活码过期
4. 用户验证权限

**预期结果**:
- ✅ 激活时可以使用
- ✅ 过期后验证返回allowed: false
- ✅ 状态自动变为expired

---

### 场景3：激活码用尽处理

1. 生成maxUses=2的激活码
2. 用户A激活（usedCount=1）
3. 用户B激活（usedCount=2）
4. 用户C尝试激活

**预期结果**:
- ✅ 用户A和B成功
- ❌ 用户C失败，提示"使用次数已达上限"

---

### 场景4：权限撤销

1. 用户激活课程
2. 超管撤销该用户的激活
3. 用户验证权限

**预期结果**:
- ✅ 撤销后status变为revoked
- ✅ 验证返回allowed: false, reason: revoked

---

### 场景5：多设备使用（账号级别）

1. 用户在电脑A激活课程
2. 用户在电脑B登录同一账号
3. 电脑B验证权限

**预期结果**:
- ✅ 电脑B无需再次激活
- ✅ 直接验证通过（账号级别激活）

---

## 边界条件测试

### 1. 激活码生成
- ✅ 生成1个激活码
- ✅ 生成100个激活码
- ❌ 生成0个 → 400错误
- ❌ 生成101个 → 400错误

### 2. 激活码格式
- ✅ 12位字符，3段，每段4位
- ✅ 只包含大写字母和数字
- ✅ 不含0O1Il

### 3. 并发激活
- 多个用户同时使用同一激活码
- ✅ 正确处理并发，不会超过maxUses

### 4. 时区处理
- ✅ validFrom和validUntil使用UTC时间
- ✅ 前端正确显示本地时间

---

## 性能测试

### 1. 批量生成激活码
- 生成100个激活码 < 2秒

### 2. 激活码列表查询
- 1000条数据分页加载 < 1秒

### 3. 激活操作
- 单次激活 < 500ms

---

## 安全测试

### 1. 权限验证
- ❌ 未登录访问 → 401
- ❌ 普通用户访问超管接口 → 403
- ❌ 学生查看其他人的激活记录 → 403

### 2. 参数验证
- ❌ SQL注入尝试 → 自动过滤
- ❌ XSS尝试 → 自动转义
- ❌ 无效ObjectId → 400错误

### 3. 重复提交
- ❌ 重复激活 → 400错误
- ✅ 幂等性保证

---

## 测试检查清单

### 后端API
- [x] 激活码生成功能正常
- [x] 激活码列表查询正常
- [x] 激活码详情查询正常
- [x] 激活码状态更新正常
- [x] 激活码删除功能正常
- [x] 用户激活功能正常
- [x] 我的激活列表正常
- [x] 权限验证功能正常
- [x] 激活记录列表正常
- [x] 撤销激活功能正常
- [x] 错误处理完善
- [x] 权限控制正确

### 前端页面
- [x] 激活码管理页面渲染正常
- [x] 激活记录页面渲染正常
- [x] 生成激活码对话框正常
- [x] 激活码详情抽屉正常
- [x] 表单验证正常
- [x] 筛选功能正常
- [x] 搜索功能正常
- [x] 分页功能正常
- [x] 错误提示正常
- [x] 成功提示正常

### 集成测试
- [ ] 完整激活流程测试通过
- [ ] 过期处理测试通过
- [ ] 用尽处理测试通过
- [ ] 撤销功能测试通过
- [ ] 多设备场景测试通过

### 文档
- [x] API文档已更新
- [x] Unity/UE5集成指南已编写
- [x] 测试指南已编写

---

## 已知限制

1. 激活码一旦生成无法修改，只能禁用或删除
2. 激活记录不支持批量操作
3. 前端搜索在客户端进行，大数据量时可能较慢（建议后端实现）
4. 激活码格式固定为12位，不支持自定义

---

## 后续优化建议

1. **导出功能**：支持导出激活码为Excel
2. **批量撤销**：支持批量撤销激活
3. **统计报表**：激活情况统计图表
4. **通知功能**：激活码即将过期提醒
5. **课程包**：一个激活码激活多个课程
6. **设备限制**：支持限制设备数量
7. **后端搜索**：激活记录搜索移到后端

---

## 测试总结

本激活码系统已完成以下功能：

✅ **后端功能**
- 激活码生成、查询、更新、删除
- 用户激活、验证、撤销
- 激活记录查询
- 权限控制
- 错误处理

✅ **前端功能**
- 激活码管理页面
- 激活记录页面
- 生成、查看、操作功能
- 筛选、搜索功能

✅ **集成文档**
- API接口文档
- Unity/UE5集成指南
- 测试指南

系统已具备生产环境使用条件，建议进行完整的集成测试后部署。

