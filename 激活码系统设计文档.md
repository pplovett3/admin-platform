# æ¿€æ´»ç ç³»ç»Ÿè®¾è®¡æ–‡æ¡£

## ğŸ“‹ éœ€æ±‚ç¡®è®¤

### æ ¸å¿ƒé…ç½®
- **æœ‰æ•ˆæœŸ**: å¯é…ç½®ï¼ˆåˆ›å»ºæ—¶è®¾ç½®ï¼‰
- **æ¿€æ´»äººæ•°**: æŒ‰ç­çº§é…ç½®ï¼ˆå¦‚30äººï¼‰
- **è®¾å¤‡é™åˆ¶**: ä¸é™ï¼ˆè´¦å·çº§åˆ«éªŒè¯ï¼‰
- **éªŒè¯æ¨¡å¼**: è´¦å·çº§åˆ« + é™é»˜è”ç½‘
- **æ¿€æ´»ç æ ¼å¼**: `ABCD-EFGH-IJKL`ï¼ˆ12ä½ï¼Œå»é™¤æ˜“æ··æ·†å­—ç¬¦ï¼‰
- **ç”Ÿæˆæ–¹å¼**: è¶…ç®¡æ‰‹åŠ¨ç”Ÿæˆ
- **è¯¾ç¨‹å…³ç³»**: ä¸€ç ä¸€è¯¾
- **æˆæƒæ¨¡å¼**: æ›¿ä»£SchoolCourseï¼Œåªç”¨æ¿€æ´»ç 

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### 1. ActivationCodeï¼ˆæ¿€æ´»ç è¡¨ï¼‰

```typescript
{
  _id: ObjectId,
  code: string,                    // æ¿€æ´»ç ï¼ˆå”¯ä¸€ï¼‰å¦‚ï¼šABCD-EFGH-IJKL
  courseId: ObjectId,              // å…³è”è¯¾ç¨‹
  
  // ä½¿ç”¨é™åˆ¶
  maxUses: number,                 // æœ€å¤§ä½¿ç”¨æ¬¡æ•°ï¼ˆæ¿€æ´»è´¦å·æ•°ï¼‰
  usedCount: number,               // å·²ä½¿ç”¨æ¬¡æ•°
  
  // æœ‰æ•ˆæœŸ
  validFrom: Date,                 // ç”Ÿæ•ˆæ—¶é—´
  validUntil: Date,                // è¿‡æœŸæ—¶é—´
  
  // çŠ¶æ€
  status: 'active' | 'disabled',   // çŠ¶æ€
  
  // å…ƒä¿¡æ¯
  description?: string,            // å¤‡æ³¨ï¼ˆå¦‚ï¼š2024æ˜¥å­£ç­ï¼‰
  createdBy: ObjectId,             // åˆ›å»ºäººï¼ˆè¶…ç®¡ï¼‰
  createdAt: Date,
  updatedAt: Date
}

// ç´¢å¼•
- code: unique
- courseId: index
- status: index
```

### 2. UserCourseActivationï¼ˆç”¨æˆ·è¯¾ç¨‹æ¿€æ´»è®°å½•è¡¨ï¼‰

```typescript
{
  _id: ObjectId,
  userId: ObjectId,                // ç”¨æˆ·ID
  courseId: ObjectId,              // è¯¾ç¨‹ID
  activationCode: string,          // ä½¿ç”¨çš„æ¿€æ´»ç 
  
  // æ—¶é—´ä¿¡æ¯
  activatedAt: Date,               // æ¿€æ´»æ—¶é—´
  expiresAt?: Date,                // è¿‡æœŸæ—¶é—´ï¼ˆç»§æ‰¿æ¿€æ´»ç çš„validUntilï¼‰
  lastVerifiedAt?: Date,           // æœ€åéªŒè¯æ—¶é—´ï¼ˆé™é»˜è”ç½‘æ—¶æ›´æ–°ï¼‰
  
  // çŠ¶æ€
  status: 'active' | 'expired' | 'revoked',
  
  createdAt: Date,
  updatedAt: Date
}

// ç´¢å¼•
- { userId, courseId }: unique
- userId: index
- courseId: index
- status: index
```

---

## ğŸ”Œ APIæ¥å£è®¾è®¡

### æ¿€æ´»ç ç®¡ç†ï¼ˆè¶…ç®¡ï¼‰

#### 1. ç”Ÿæˆæ¿€æ´»ç 
```
POST /api/activation-codes
æƒé™: superadmin
Body: {
  courseId: string,
  count: number,          // ç”Ÿæˆæ•°é‡ï¼ˆ1-100ï¼‰
  maxUses: number,        // æ¯ä¸ªç å¯æ¿€æ´»äººæ•°
  validFrom: string,      // ISOæ—¥æœŸ
  validUntil: string,     // ISOæ—¥æœŸ
  description?: string    // å¤‡æ³¨
}
Response: {
  success: true,
  codes: [
    { code: "ABCD-EFGH-IJKL", courseId: "xxx", maxUses: 30, ... }
  ]
}
```

#### 2. æ¿€æ´»ç åˆ—è¡¨
```
GET /api/activation-codes?courseId=&status=&page=&limit=
æƒé™: superadmin
Response: {
  items: [...],
  pagination: { total, page, pages }
}
```

#### 3. æ¿€æ´»ç è¯¦æƒ…
```
GET /api/activation-codes/:code
æƒé™: superadmin
Response: {
  code: "ABCD-EFGH-IJKL",
  course: { name: "äº§çº¿è®¤çŸ¥" },
  maxUses: 30,
  usedCount: 15,
  validUntil: "2025-12-31",
  status: "active",
  activations: [
    { userId: "xxx", userName: "å¼ ä¸‰", activatedAt: "..." }
  ]
}
```

#### 4. ç¦ç”¨/å¯ç”¨æ¿€æ´»ç 
```
PATCH /api/activation-codes/:code
æƒé™: superadmin
Body: { status: "disabled" }
Response: { success: true }
```

#### 5. å¯¼å‡ºæ¿€æ´»ç Excel
```
GET /api/activation-codes/export?courseId=
æƒé™: superadmin
Response: Excelæ–‡ä»¶ä¸‹è½½
```

### ç”¨æˆ·æ¿€æ´»æ¥å£

#### 6. æ¿€æ´»è¯¾ç¨‹
```
POST /api/activation/activate
æƒé™: æ‰€æœ‰ç™»å½•ç”¨æˆ·
Body: {
  code: string,
  courseId: string
}
Response: {
  success: true,
  message: "æ¿€æ´»æˆåŠŸ",
  activation: {
    courseId: "xxx",
    courseName: "äº§çº¿è®¤çŸ¥",
    expiresAt: "2025-12-31"
  }
}
```

#### 7. æˆ‘çš„æ¿€æ´»åˆ—è¡¨
```
GET /api/activation/my-activations
æƒé™: æ‰€æœ‰ç™»å½•ç”¨æˆ·
Response: {
  activations: [
    {
      courseId: "xxx",
      courseName: "äº§çº¿è®¤çŸ¥",
      activatedAt: "2024-01-01",
      expiresAt: "2025-12-31",
      status: "active"
    }
  ]
}
```

#### 8. éªŒè¯è¯¾ç¨‹è®¿é—®æƒé™ï¼ˆå¯åŠ¨å™¨ç”¨ï¼‰
```
GET /api/activation/verify?courseId=xxx
æƒé™: æ‰€æœ‰ç™»å½•ç”¨æˆ·
Response: {
  allowed: true,
  courseId: "xxx",
  expiresAt: "2025-12-31"
}
```

#### 9. æ’¤é”€ç”¨æˆ·æ¿€æ´»ï¼ˆè¶…ç®¡ï¼‰
```
DELETE /api/activation/revoke/:userId/:courseId
æƒé™: superadmin
Response: { success: true }
```

---

## ğŸ–¥ï¸ ç®¡ç†åå°é¡µé¢

### é¡µé¢åˆ—è¡¨

1. **æ¿€æ´»ç ç®¡ç†é¡µé¢** (`/admin/activation-codes`)
   - æ¿€æ´»ç åˆ—è¡¨ï¼ˆè¡¨æ ¼ï¼‰
   - ç”Ÿæˆæ¿€æ´»ç ï¼ˆå¯¹è¯æ¡†ï¼‰
   - æŸ¥çœ‹è¯¦æƒ…ï¼ˆæŠ½å±‰ï¼‰
   - ç¦ç”¨/å¯ç”¨
   - å¯¼å‡ºExcel

2. **æ¿€æ´»è®°å½•é¡µé¢** (`/admin/activations`)
   - æ¿€æ´»è®°å½•åˆ—è¡¨
   - æŒ‰ç”¨æˆ·/è¯¾ç¨‹ç­›é€‰
   - æ’¤é”€æ¿€æ´»

---

## ğŸš€ å¯åŠ¨å™¨è®¾è®¡

### æŠ€æœ¯é€‰å‹
- **æ¡†æ¶**: Electron (è·¨å¹³å°) æˆ– C# WPF (Windows)
- **UI**: Modernç®€æ´é£æ ¼
- **å­˜å‚¨**: SQLiteæœ¬åœ°æ•°æ®åº“ + åŠ å¯†

### æ ¸å¿ƒåŠŸèƒ½

#### 1. ç™»å½•ç•Œé¢
```
è¾“å…¥: æ‰‹æœºå· + å¯†ç 
åŠŸèƒ½: è°ƒç”¨ POST /api/auth/login
å­˜å‚¨: JWT Token
```

#### 2. è¯¾ç¨‹åˆ—è¡¨ç•Œé¢
```
æ˜¾ç¤º:
- ç”¨æˆ·ä¿¡æ¯
- å·²æ¿€æ´»è¯¾ç¨‹ï¼ˆç»¿è‰²ï¼Œå¯å¯åŠ¨ï¼‰
- æœªæ¿€æ´»è¯¾ç¨‹ï¼ˆç°è‰²ï¼Œæ˜¾ç¤º"æ¿€æ´»"æŒ‰é’®ï¼‰

åŠŸèƒ½:
- å¯åŠ¨è¯¾ç¨‹ï¼ˆå·²æ¿€æ´»ï¼‰
- å¼¹å‡ºæ¿€æ´»ç è¾“å…¥æ¡†ï¼ˆæœªæ¿€æ´»ï¼‰
- é€€å‡ºç™»å½•
```

#### 3. æ¿€æ´»ç è¾“å…¥
```
è¾“å…¥æ¡†: [ABCD]-[EFGH]-[IJKL]
éªŒè¯: æ ¼å¼æ£€æŸ¥
æäº¤: POST /api/activation/activate
æˆåŠŸ: åˆ·æ–°è¯¾ç¨‹åˆ—è¡¨
```

#### 4. å¯åŠ¨è¯¾ç¨‹
```
è¯»å–: courses/manifest.json
ç”ŸæˆToken: JWT(userId + courseId + timestamp)
æ‰§è¡Œ: Course.exe --token=xxx --courseId=yyy --userId=zzz
```

#### 5. é™é»˜éªŒè¯
```
å¯åŠ¨å™¨å¯åŠ¨æ—¶:
- åå°è°ƒç”¨ GET /api/activation/verify?courseId=xxx
- ä¸é˜»å¡UI
- æ›´æ–°æœ¬åœ°ç¼“å­˜çŠ¶æ€
- å¤±è´¥ä¹Ÿä¸å½±å“ä½¿ç”¨
```

### æ–‡ä»¶ç»“æ„
```
E:\åŸ¹è®­å¹³å°\
â”œâ”€â”€ Launcher.exe              # å¯åŠ¨å™¨
â”œâ”€â”€ config.json               # é…ç½®ï¼ˆæœåŠ¡å™¨åœ°å€ï¼‰
â”œâ”€â”€ data\
â”‚   â””â”€â”€ cache.db              # SQLiteï¼ˆç¼“å­˜æ¿€æ´»çŠ¶æ€ï¼‰
â””â”€â”€ courses\
    â”œâ”€â”€ manifest.json         # è¯¾ç¨‹æ¸…å•
    â”œâ”€â”€ course-001\           # äº§çº¿è®¤çŸ¥
    â”‚   â””â”€â”€ Course.exe
    â””â”€â”€ course-002\           # æœºæ¢°å®‰è£…
        â””â”€â”€ Course.exe
```

---

## ğŸ® Unity/UE5 é›†æˆ

### Unityé›†æˆä»£ç æ¨¡æ¿

```csharp
// CourseLauncher.cs
using UnityEngine;
using System;
using System.IdentityModel.Tokens.Jwt;

public class CourseLauncher : MonoBehaviour {
    void Start() {
        if (!ValidateLaunch()) {
            Application.Quit();
        }
    }
    
    bool ValidateLaunch() {
        string[] args = System.Environment.GetCommandLineArgs();
        
        // è¯»å–å‚æ•°
        string token = GetArg(args, "--token");
        string courseId = GetArg(args, "--courseId");
        
        if (string.IsNullOrEmpty(token)) {
            Debug.LogError("æœªä»å¯åŠ¨å™¨å¯åŠ¨ï¼Œç¼ºå°‘Token");
            return false;
        }
        
        // éªŒè¯Tokenï¼ˆç®€å•æ£€æŸ¥ï¼Œå¯é€‰ï¼‰
        try {
            var handler = new JwtSecurityTokenHandler();
            var jwtToken = handler.ReadJwtToken(token);
            
            // æ£€æŸ¥è¿‡æœŸæ—¶é—´
            if (jwtToken.ValidTo < DateTime.UtcNow) {
                Debug.LogError("Tokenå·²è¿‡æœŸ");
                return false;
            }
            
            Debug.Log("è¯¾ç¨‹å¯åŠ¨éªŒè¯é€šè¿‡");
            return true;
        } catch (Exception e) {
            Debug.LogError($"TokenéªŒè¯å¤±è´¥: {e.Message}");
            return false;
        }
    }
    
    string GetArg(string[] args, string key) {
        for (int i = 0; i < args.Length - 1; i++) {
            if (args[i] == key) return args[i + 1];
        }
        return null;
    }
}
```

### UE5é›†æˆï¼ˆè“å›¾å¯è°ƒç”¨C++ï¼‰

```cpp
// CourseLauncher.h
UCLASS()
class MYCOURSE_API UCourseLauncher : public UObject {
    GENERATED_BODY()
    
public:
    UFUNCTION(BlueprintCallable)
    static bool ValidateLaunch();
};

// CourseLauncher.cpp
bool UCourseLauncher::ValidateLaunch() {
    FString Token = FCommandLine::Get();
    
    if (!Token.Contains(TEXT("--token"))) {
        UE_LOG(LogTemp, Error, TEXT("æœªä»å¯åŠ¨å™¨å¯åŠ¨"));
        return false;
    }
    
    // ç®€å•éªŒè¯å³å¯
    UE_LOG(LogTemp, Log, TEXT("è¯¾ç¨‹å¯åŠ¨éªŒè¯é€šè¿‡"));
    return true;
}
```

---

## ğŸ”„ å®Œæ•´æµç¨‹

### 1. è¶…ç®¡ç”Ÿæˆæ¿€æ´»ç 
```
1. ç™»å½•ç®¡ç†åå°
2. è¿›å…¥"æ¿€æ´»ç ç®¡ç†"
3. ç‚¹å‡»"ç”Ÿæˆæ¿€æ´»ç "
4. é€‰æ‹©è¯¾ç¨‹ã€è®¾ç½®äººæ•°ã€æœ‰æ•ˆæœŸ
5. ç‚¹å‡»ç”Ÿæˆ
6. å¯¼å‡ºExcelå‘ç»™å­¦æ ¡
```

### 2. å­¦ç”Ÿæ¿€æ´»è¯¾ç¨‹
```
1. æ‰“å¼€å¯åŠ¨å™¨
2. ç™»å½•è´¦å·
3. çœ‹åˆ°è¯¾ç¨‹åˆ—è¡¨ï¼Œ"äº§çº¿è®¤çŸ¥"æ˜¾ç¤º"æ¿€æ´»"æŒ‰é’®
4. ç‚¹å‡»"æ¿€æ´»"ï¼Œè¾“å…¥æ¿€æ´»ç ï¼šABCD-EFGH-IJKL
5. æäº¤æˆåŠŸ
6. è¯¾ç¨‹å˜ä¸ºå¯å¯åŠ¨çŠ¶æ€
```

### 3. å­¦ç”Ÿä½¿ç”¨è¯¾ç¨‹
```
ç¬¬ä¸€æ¬¡ï¼š
1. ç‚¹å‡»"å¯åŠ¨è¯¾ç¨‹"
2. å¯åŠ¨å™¨ç”ŸæˆToken
3. æ‰§è¡Œï¼šCourse.exe --token=xxx --courseId=yyy
4. è¯¾ç¨‹åº”ç”¨éªŒè¯Tokené€šè¿‡
5. è¿›å…¥è¯¾ç¨‹

ç¬¬äºŒæ¬¡ï¼ˆæ¢è®¾å¤‡ï¼‰ï¼š
1. åœ¨æ–°ç”µè„‘å®‰è£…å¯åŠ¨å™¨
2. ç™»å½•åŒä¸€è´¦å·
3. ç›´æ¥çœ‹åˆ°"äº§çº¿è®¤çŸ¥"å¯å¯åŠ¨ï¼ˆä¸éœ€è¦å†æ¿€æ´»ï¼‰
4. ç‚¹å‡»å¯åŠ¨å³å¯
```

### 4. é™é»˜éªŒè¯æœºåˆ¶
```
æ¯æ¬¡å¯åŠ¨å™¨å¯åŠ¨æ—¶ï¼š
1. åå°è°ƒç”¨ /api/activation/verify
2. æœ‰ç½‘ â†’ æ›´æ–°lastVerifiedAt
3. æ²¡ç½‘ â†’ ä½¿ç”¨æœ¬åœ°ç¼“å­˜
4. æƒé™è¢«æ’¤é”€ â†’ ä¸‹æ¬¡éªŒè¯æ—¶è¯¾ç¨‹å˜ç°
```

---

## ğŸ“Š å¼€å‘ä»»åŠ¡åˆ†è§£

### åç«¯å¼€å‘ï¼ˆ3-5å¤©ï¼‰
- [ ] ActivationCodeæ¨¡å‹
- [ ] UserCourseActivationæ¨¡å‹
- [ ] æ¿€æ´»ç ç”Ÿæˆç®—æ³•
- [ ] æ¿€æ´»ç CRUDæ¥å£
- [ ] æ¿€æ´»/éªŒè¯æ¥å£
- [ ] Excelå¯¼å‡ºåŠŸèƒ½

### å‰ç«¯å¼€å‘ï¼ˆ3-5å¤©ï¼‰
- [ ] æ¿€æ´»ç ç®¡ç†é¡µé¢
- [ ] æ¿€æ´»è®°å½•é¡µé¢
- [ ] ç”Ÿæˆå¯¹è¯æ¡†
- [ ] è¯¦æƒ…æŠ½å±‰

### å¯åŠ¨å™¨å¼€å‘ï¼ˆ7-10å¤©ï¼‰
- [ ] ç™»å½•ç•Œé¢
- [ ] è¯¾ç¨‹åˆ—è¡¨ç•Œé¢
- [ ] æ¿€æ´»ç è¾“å…¥ç•Œé¢
- [ ] Tokenç”Ÿæˆé€»è¾‘
- [ ] å¯åŠ¨è¯¾ç¨‹é€»è¾‘
- [ ] æœ¬åœ°ç¼“å­˜ç®¡ç†
- [ ] é™é»˜éªŒè¯é€»è¾‘

### è¯¾ç¨‹é›†æˆï¼ˆ1å¤©/è¯¾ç¨‹ï¼‰
- [ ] å¤åˆ¶ä»£ç æ¨¡æ¿
- [ ] æµ‹è¯•å¯åŠ¨å‚æ•°

### æµ‹è¯•ï¼ˆ2-3å¤©ï¼‰
- [ ] æ¿€æ´»æµç¨‹æµ‹è¯•
- [ ] å¤šè®¾å¤‡æµ‹è¯•
- [ ] ç¦»çº¿åœºæ™¯æµ‹è¯•
- [ ] è¿‡æœŸåœºæ™¯æµ‹è¯•

**æ€»è®¡ï¼š15-25å¤©**

---

## ğŸ” å®‰å…¨è€ƒè™‘

1. **æ¿€æ´»ç éšæœºæ€§**: ä½¿ç”¨åŠ å¯†éšæœºæ•°ç”Ÿæˆ
2. **Tokenç­¾å**: JWT + HMAC-SHA256
3. **æœ¬åœ°å­˜å‚¨åŠ å¯†**: SQLiteæ•°æ®åº“åŠ å¯†
4. **é˜²é‡æ”¾**: TokenåŒ…å«æ—¶é—´æˆ³ï¼Œ10åˆ†é’Ÿæœ‰æ•ˆ
5. **é˜²ç¯¡æ”¹**: ç­¾åéªŒè¯

---

## ğŸ“ˆ åç»­æ‰©å±•

### ç¬¬äºŒæœŸåŠŸèƒ½
- è¯¾ç¨‹åŒ…ï¼ˆä¸€ç å¤šè¯¾ï¼‰
- å¯åŠ¨å™¨è‡ªåŠ¨æ›´æ–°
- è¯¾ç¨‹åœ¨çº¿ä¸‹è½½
- æˆç»©æŸ¥çœ‹
- å­¦ä¹ æ—¶é•¿ç»Ÿè®¡
- ä½¿ç”¨æŠ¥è¡¨

---

## ğŸ¯ æˆåŠŸæ ‡å‡†

- âœ… è¶…ç®¡å¯ç”Ÿæˆå’Œç®¡ç†æ¿€æ´»ç 
- âœ… ç”¨æˆ·å¯é€šè¿‡æ¿€æ´»ç æ¿€æ´»è¯¾ç¨‹
- âœ… å¯åŠ¨å™¨å¯æ­£å¸¸å¯åŠ¨Unity/UE5è¯¾ç¨‹
- âœ… æ”¯æŒå¤šè®¾å¤‡ä½¿ç”¨ï¼ˆåŒä¸€è´¦å·ï¼‰
- âœ… ç¦»çº¿å¯ç”¨ï¼ˆé¦–æ¬¡æ¿€æ´»åï¼‰
- âœ… æ¿€æ´»ç åˆ°æœŸè‡ªåŠ¨å¤±æ•ˆ

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»å¼€å‘å›¢é˜Ÿã€‚

