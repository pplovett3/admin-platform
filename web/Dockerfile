FROM node:20-alpine
WORKDIR /app
ENV NEXT_TELEMETRY_DISABLED=1

COPY package*.json ./
# å…ˆå®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆåŒ…æ‹¬ devDependenciesï¼Œæ„å»ºæ—¶éœ€è¦ TypeScriptï¼‰
# æ³¨æ„ï¼šæ­¤æ—¶ä¸è®¾ç½® NODE_ENV=productionï¼Œç¡®ä¿ devDependencies è¢«å®‰è£…
RUN npm ci --legacy-peer-deps

# éªŒè¯ TypeScript å·²å®‰è£…
RUN ls -la node_modules/typescript 2>/dev/null && echo "âœ“ TypeScript installed" || (echo "âœ— TypeScript NOT installed, installing..." && npm install --legacy-peer-deps --save-dev typescript@^5 @types/react@^18 @types/node@^20 @types/react-dom@^18 @types/three@^0.179.0)

# ğŸ”¥ å¼ºåˆ¶ç ´åç¼“å­˜ï¼šä¼ å…¥æ„å»ºæ—¶é—´æˆ³ï¼Œç¡®ä¿æ¯æ¬¡éƒ½é‡æ–°å¤åˆ¶ä»£ç 
ARG CACHEBUST=1
RUN echo "Cache bust: $CACHEBUST"

COPY . .

# ç°åœ¨è®¾ç½®ç”Ÿäº§ç¯å¢ƒå˜é‡
ENV NODE_ENV=production

# éªŒè¯å…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼ˆè°ƒè¯•ç”¨ï¼‰
RUN echo "=== æ£€æŸ¥æ–‡ä»¶ç»“æ„ ===" && \
    ls -la app/ | head -20 && \
    echo "=== æ£€æŸ¥ _utils ç›®å½• ===" && \
    ls -la app/_utils/ && \
    echo "=== æ£€æŸ¥ _lib ç›®å½• ===" && \
    ls -la app/_lib/ && \
    echo "=== æ£€æŸ¥ tsconfig.json ===" && \
    cat tsconfig.json

# æ¥å—æ„å»ºå‚æ•°å¹¶è®¾ç½®ä¸ºç¯å¢ƒå˜é‡
# é»˜è®¤ä¸ºç©ºï¼Œè®©å‰ç«¯ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼ˆé€šè¿‡ Nginx åå‘ä»£ç†ï¼‰
ARG NEXT_PUBLIC_API_URL=
ENV NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}

# ç¡®ä¿ node_modules/.bin æœ‰æ‰§è¡Œæƒé™ï¼ˆé˜²æ­¢ä» Windows ä¸Šä¼ å¯¼è‡´çš„æƒé™é—®é¢˜ï¼‰
RUN chmod -R +x node_modules/.bin 2>/dev/null || true

# ç¡®ä¿ app ç›®å½•ä¸‹çš„æ–‡ä»¶æœ‰æ­£ç¡®çš„æƒé™
RUN chmod -R 644 app/**/*.ts app/**/*.tsx 2>/dev/null || true

# æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§æ„å»ºç¼“å­˜ï¼Œç¡®ä¿ä½¿ç”¨æœ€æ–°ä»£ç 
RUN rm -rf .next 2>/dev/null || true

# è¿è¡Œæ„å»º
RUN npm run build

EXPOSE 3000
CMD ["npm", "start"] 