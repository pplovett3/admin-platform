# 显隐轨道JSON加载修复测试指南

## 🎯 问题描述
JSON中有显隐信息，但加载动画时没有解析出轨道和关键帧。

## 🔧 修复内容

### 1. 根本原因
- 新的JSON格式使用**对象路径**作为键（如 `"Tyre/Rim"`）
- 但时间线需要**UUID**作为键来正确显示轨道
- 原有的加载逻辑没有正确处理路径→UUID的转换

### 2. 修复逻辑
更新了 `tryRestoreFromPending` 函数中的显隐轨道处理：

```javascript
// 新增三级查找策略:
1. UUID直接匹配 (兼容旧数据)
2. 对象路径匹配 (新JSON格式)
3. 灵活路径匹配 (findByFlexiblePath)
```

## 📋 测试步骤

### 步骤1: 清理缓存并刷新
1. 刷新浏览器页面
2. 打开开发者工具控制台

### 步骤2: 加载含显隐数据的课件
1. 确保您的课件JSON中包含显隐轨道数据
2. 观察控制台输出

### 步骤3: 查看预期日志
应该看到类似的输出：
```
📋 处理新格式显隐轨道: 1个轨道
  [路径匹配] Tyre/Rim → Rim (a1b2c3d4)
  ✅ 恢复显隐轨道: Tyre/Rim → Rim, 4个关键帧

动画数据恢复完成，共 1 个动画
```

### 步骤4: 验证轨道显示
1. 查看时间线下方的轨道区域
2. 应该能看到：
   - **显隐轨道**：黄色圆点标记
   - **对象名称**：显示在轨道左侧
   - **关键帧**：在对应时间点显示

### 步骤5: 测试播放效果
1. 点击播放按钮
2. 观察对象在指定时间点的显隐变化
3. 检查时间线指示器移动时的实时效果

## 🐛 故障排除

### 问题1: 仍然看不到轨道
**可能原因**: 对象路径不匹配
**解决方案**: 
1. 检查控制台是否有 `❌ 未找到对象: [路径]` 的警告
2. 检查模型中对象的实际名称路径
3. 确认JSON中的路径格式是否正确

### 问题2: 路径匹配失败
**调试方法**:
```javascript
// 在控制台中检查对象路径
Array.from(keyToObject.current.entries()).forEach(([uuid, obj]) => {
  console.log(`${buildNamePath(obj)} → ${obj.name} (${uuid.slice(0,8)})`);
});
```

### 问题3: 关键帧数据错误
**检查点**:
- JSON中的 `visible` 字段是否为布尔值
- `time` 字段是否为数字
- 数据结构是否完整

## 📊 数据格式验证

### 正确的JSON格式
```json
{
  "animations": [
    {
      "timeline": {
        "visibilityTracks": {
          "Tyre/Rim": [
            {"time": 0, "visible": true},
            {"time": 2, "visible": false},
            {"time": 4, "visible": true}
          ]
        }
      }
    }
  ]
}
```

### 常见错误格式
```json
// ❌ 错误: 使用 value 而非 visible
{"time": 0, "value": true}

// ❌ 错误: 缺少对象路径
"": [{"time": 0, "visible": true}]

// ❌ 错误: 使用UUID而非路径（会导致重新加载时失效）
"a1b2c3d4-uuid": [{"time": 0, "visible": true}]
```

## ✅ 验证清单

- [ ] 控制台显示 "处理新格式显隐轨道" 消息
- [ ] 每个轨道都有 "路径匹配" 或 "UUID匹配" 成功消息  
- [ ] 时间线下方显示显隐轨道（黄色圆点）
- [ ] 轨道标签显示正确的对象名称
- [ ] 播放动画时对象按时间点显隐
- [ ] 无 "未找到对象" 的错误消息

## 🎯 成功标准

修复成功后，您应该能够：
1. 在时间线中看到显隐轨道
2. 看到正确的关键帧标记
3. 播放动画时对象正常显隐
4. 控制台没有路径匹配错误

如果仍有问题，请检查具体的错误消息并按照故障排除步骤进行调试。

